\section{Methods}
\label{sec:hsolid-methods}

\subsection{Candidate Structure Optimization}
% modified from supp1-geo.tex
We considered three candidates C2/c-24, Cmca-4, Cmca-12 for the molecular phase and one candidate I4$_1$/amd for the atomic phase at $T=0K$ over the pressure range 350 GPa to 700 GPa. The static-lattice structures in the molecular phase are optimized by vdW-DF at constant pressure.
As shown in Table~\ref{tab:hsolid-mol-press-rs}, all three molecular structures optimize to roughly the same density at each pressure.
\begin{table}[h]
% 2020/05/18 notes, extracted from h11/analysis/11a_axes_pos.json
\centering
\begin{tabular}{ccccccc}
\toprule
vdW-DF P(GPa) & 360 & 400 & 440 & 480 & 520 & 560 \\
\midrule
Cmca-4  & 1.303 & 1.283 & 1.265 & 1.250 & 1.235 & 1.222 \\
Cmca-12 & 1.306 & 1.286 & 1.268 & 1.252 & 1.237 & 1.224 \\
C2/c-24 & 1.307 & 1.287 & 1.269 & 1.253 & 1.239 & 1.225 \\
\bottomrule
\end{tabular}
\caption{vdW-DF pressure-density (expressed in $r_s$) relation of relaxed molecular candidate structures.}
\label{tab:hsolid-mol-press-rs}
\end{table}
In contrast, the atomic structure is optimized using DMC at constant volume.

All three molecular structures are monoclinic having $a=b\neq c$, $\alpha=\beta=90^\circ+\eta$, and $\gamma=120^\circ+\delta$. The slight distortions differ for each structure: $\eta=0$, $\delta\approx -0.5^\circ$ for Cmca-4, $\eta=0$, $\delta\approx+3.5^\circ$ for Cmca-12, and $\eta\approx0.1^\circ$, $\delta\approx-0.1^\circ$ for C2/c-24.
The evolution of the lattice parameters as a function of pressure are shown in Fig.~\ref{fig:hsolid-vdw-ca}(a).
Both $a$ and $c$ decrease with increasing pressure.
However, the $c/a$ ratio remains roughly constant at $1.062\pm0.003$ and $1.771\pm0.003$ for Cmca-12 and C2c-24, respectively.
In contrast, the $c/a$ ratio of the Cmca-4 structure decreases from $1.562$ at $350$ GPa to $1.530$ at $560$ GPa linearly with pressure.
Besides having slightly different unit cells, the Cmca-4 structure has only one type of H$_2$ molecule, whereas Cmca-12 and C2/c have two.

The vdW-DF optimized H$_2$ bond lengths of all three molecular structures are shown in Fig.~\ref{fig:hsolid-vdw-ca}(b).
The bond length in Cmca-4 is comparable to its isolated value of $1.4$ Bohr, whereas in C2/c-24 it is 3 to 4\% compressed.
One type of the H$_2$ molecules in Cmca-12 has pressure-sensitive bond length, increasing from $\sim 1.38$ Bohr at 360 GPa to $\sim 1.4$ Bohr at 560 GPa, while the other type has 3\% compressed bond length irrespective of pressure.

\begin{figure}[h]
\centering
\begin{minipage}{0.49\textwidth}
\centering
\includegraphics[width=\linewidth]{h11_mol-ca}
(a) $a$ and $c$ lattice parameters
\end{minipage}
\begin{minipage}{0.49\textwidth}
\centering
\includegraphics[width=\linewidth]{h11_mol-rb}
(a) H$_2$ bond length
\end{minipage}
\caption{vdW-DF optimized molecular candidate structures.}
\label{fig:hsolid-vdw-ca}
\end{figure}

While the vdW-DF optimized structures in Ref.~\cite{McMinis2015} are not published, we can infer from the enthalpy-pressure relations that the same structures have been reproduced in this study. Figure~\ref{fig:dft-opt-geo} shows the enthalpy of each candidate structure relative to C2/c-24 at the vdW-DF static-lattice minimum. The results agree well with those from McMinis et al.~\cite{McMinis2015} where available.
In comparison to predictions by Drummond \textit{et al.}~\cite{Drummond2015}, our C2/c structure is slightly more stable and Cmca-4 slightly less stable.
They used BLYP rather than vdW-DF functional, so differences are expected. In fact, it is encouraging to see two different functionals give similar results (within a few meV/p).

\begin{figure}[h]
\centering
\includegraphics[width=0.6\columnwidth]{010a_dh-vs-p}
\caption{DFT(vdW-DF) static-lattice enthalpy of optimized structures relative to C2/c-24. Thin solid lines are enthalpies of the Cmca-4, Cmca-12 and I4$_1$/amd using our optimized structures. Dashed lines are DFT(BLYP) enthalpies of Cmca-4 and Cmca-12 from Drummond \textit{et al.}~\cite{Drummond2015}. Dash-dot lines are DFT(vdW-DF) enthalpies from McMinis \textit{et al.}~\cite{McMinis2015}.}
\label{fig:dft-opt-geo}
\end{figure}

\subsection{Supercell Construction}
% modified from supp2-static-qmc.tex
To reliably obtain QMC energy values in the thermodynamic limit, we need to tile the optimized primitive cells to sufficiently large supercells so that pair correlation functions are converged.
The remaining finite-size error can be removed using methods to be discussed in Chap.~\ref{chap:fsc}.
The supercells also need to be small enough for dynamic-ion QMC to be practical.
In the end, we chose to perform all QMC calculations using 72-atom simulation cells. Each simulation cell is tiled from the optimized unit cell using a non-diagonal supercell matrix~\cite{Lloyd-Williams2015}, which is optimized to have large distances between minimum images.
A supercell matrix in 3D is a $3\times 3$ matrix of integers that map primitive lattice vectors $\bs{a}, \bs{b}, \bs{c}$ to supercell lattice vectors  $\bs{a}_s, \bs{b}_s, \bs{c}_s$
\begin{align}
\left(\begin{array}{c}
\bs{a}_s \\
\bs{b}_s \\
\bs{c}_s
\end{array}\right) =
\left(\begin{array}{ccc}
S_{11} & S_{12} & S_{13} \\
S_{21} & S_{22} & S_{23} \\
S_{31} & S_{32} & S_{33}
\end{array}\right)
\left(\begin{array}{c}
\bs{a} \\
\bs{b} \\
\bs{c}
\end{array}\right).
\end{align}
Once a supercell is chosen, the crystal structure can be created using the following cropping method. One first tiles the atoms in the primitive cell a large number of times along each dimension, then crop out only the atoms that fall inside the supercell.
The total number of atoms in the supercell should be $\det S$ times larger than that in the primitive cell.

Non-diagonal supercell matrices can be useful for maximizing the minimum image radius, a.k.a. radius of the real-space Wigner-Seitz cell, $R_{WS}$.
As shown in Fig.~\ref{fig:hsolid-square-vs-rhombus}, a rhombus supercell provides a larger $R_{WS}$ than a square having the same area.
This is because the images form a closed-packed lattice with a rhombus supercell.
If the primitive cell is square, then all diagonal supercell matrices result in square supercells. In contract, one can construct a rhombus-like supercell using a non-diagonal matrix. Arguably the more useful application of non-diagonal supercell matrix is for accessing a particular momentum to address a certain excitation~\cite{Lloyd-Williams2015}, which is beyond the scope of this study.
\begin{figure}[h]
\centering
\begin{minipage}{0.49\textwidth}
\centering
\includegraphics[width=0.66666\linewidth]{supercell-square}\\
(a) square $a=2$ \AA
\end{minipage}
\begin{minipage}{0.49\textwidth}
\centering
\includegraphics[width=\linewidth]{supercell-rhombus}\\
(b) rhombus $a=2.149$ \AA
\end{minipage}
\caption{Cubic vs. rhombus supercells. The black cell is the supercell. The gray cells are periodic images. The blue line points between nearest-neighbor images, while the red line between second-nearest neighbors. The yellow circle is the inscribed circle in the Wigner-Seitz cell (not shown) of the supercell.}
\label{fig:hsolid-square-vs-rhombus}
\end{figure}

The chosen supercell matrices and their resulting image radii are shown in Table~\ref{tab:hsolid-tmat72} and Fig.~\ref{fig:cell-radius}, respectively.
The inscribing radius of each supercell $R_{sc}$ are also shown in Fig.~\ref{fig:cell-radius} to give a sense of how far each supercell is from being orthorhombic. An orthorhombic cell has $R_{WS} = R_{sc}$.
\begin{table}[h]
\centering
\caption{Optimized 72-atom non-diagonal supercell matrices.}
\label{tab:hsolid-tmat72}
\begin{tabular}{cccc}
\hline\hline
Cmca-4 & Cmca-12 & C2/c-24 & I4$_1$/amd \\
\hline
$\left(\begin{array}{rrr}
-1 &  2 &  1 \\
 2 & -1 &  1 \\
 3 &  3 &  0 \\
\end{array}\right)$ & $\left(\begin{array}{rrr}
 2 &  1 &  -1 \\
 2 &  1 &   1 \\
 -1 &  1 &  0 \\
\end{array}\right)$ & $\left(\begin{array}{rrr}
 2 &  1 &  0 \\
 1 &  2 &  0 \\
 0 &  0 &  1
\end{array}\right)$ & $\left(\begin{array}{rrr}
 2 & -2 &  1 \\
 2 &  3 &  0 \\
-2 &  1 &  1
\end{array}\right)$ \\
\hline\hline
\end{tabular}
\end{table}

\begin{figure}[h]
\centering
\includegraphics[width=0.6\columnwidth]{101a1_cell-radius}
\caption{Supercell radius as a function of density. $r_s$ is the Wigner-Seitz radius, which is determined by the average electron density $\frac{4\pi}{3}r_s=\rho$, where $\rho=N_e/\Omega$, with $\Omega$ the supercell volume. $R_{WS}$ is the radius of the real-space Wigner-Seitz cell of the supercell. $2R_{WS}$ is the minimum distance between periodic images. \label{fig:cell-radius}}
\end{figure}

%\input{papers/hsolid/supp1-geo}
%\input{papers/hsolid/supp2-static-qmc}

\subsection{Electronic Wavefunction Optimization}
For the electronic wave function, we use the standard Slater-Backflow-Jastrow form
\begin{align}
\Psi(\bs{R};\bs{R}_I) = \det e^{-U} \\
U = \sum_{\alpha,\beta} u_{\alpha\beta}(r).
\end{align}
The Jastrow and back flow functions are variationally using the electronic hamiltonian at vdW-DF optimized lattice geometries. The optimized functions at 480 GPa ($r_s\approx 1.25$) are shown in Fig.~\ref{fig:hsolid-static-jas-bf}.
These functions remain roughly identical across all densities explored.
The electronic components of the Jastrow and back flow functions are nearly identical for all three molecular candidates.
The largest contribution is the ``u-d'' term, which introduces correlation between unlike-spin electrons to keep them apart.

\begin{figure}[h]
\centering
\begin{minipage}{0.49\textwidth}
\centering
\includegraphics[width=\linewidth]{h117_mol-jas-rs125}\\
(a) Jastrow pair functions
\end{minipage}
\begin{minipage}{0.49\textwidth}
\centering
\includegraphics[width=\linewidth]{h117_mol-bf-rs125}\\
(b) Back flow pair functions
\end{minipage}
\caption{Jastrow and back flow pair functions optimized at static-lattice minimum at 480 GPa. Color denotes the crystal structure. The solid line is the pair function for electron-proton, the dashed line for same-spin electrons, and the dotted lines for unlike-spin electrons.}
\label{fig:hsolid-static-jas-bf}
\end{figure}

Before back flow transformation, the static structure factor of the Slater determinant is quite similar to that of the unpolarized homogeneous electron gas, as shown in Fig.~\ref{fig:hsolid-det-sk-nk}(a). However, the its momentum distribution is quite different, because the molecular structures are insulating.

\begin{figure}[h]
\centering
\begin{minipage}{0.49\textwidth}
\centering
\includegraphics[width=\linewidth]{h117_mol-detsk-rs125}\\
(a) structure factor
\end{minipage}
\begin{minipage}{0.49\textwidth}
\centering
\includegraphics[width=\linewidth]{h117_mol-detnk-rs125}\\
(b) momentum distribution
\end{minipage}
\caption{Static structure factor $S_0(k)$ and momentum distribution $n_0(k)$ calculated using the Kohn-Sham determinant wave function.}
\label{fig:hsolid-det-sk-nk}
\end{figure}

\subsection{Electron-ion Wavefunction Optimization}

The Slater-Jastrow wavefunction has an additional product for the ions and an ion-ion Jastrow when generalized to an electron-ion system with distinguishable ions.
After optimizing using dynamic-ion VMC, the electronic Jastrow and back flow pair functions of all three molecular structures converge to the same set of functions.
As shown in Fig.~\ref{fig:hsolid-dynamic-jas-bf}, the only noticeable difference among the three structures come from the proton-proton Jastrow.

We use a product of isotropic gaussians as the wave function for the protons in the molecular structures.
The width of the gaussians are optimized using maximum overlap.
In this method, we measure the root-mean-squared deviation (RMSD) of each proton from its ideal site, as determined by vdW-DF, and adjust the gaussian exponent in the proton wave function $C_p$ until the VMC and DMC estimates of the RMSD agree.
This method works by maximizing the overlap between the trial and ground-state wave function along the dimension controlled by $C_p$.
Since proton RMSD is a rather direct measure of the shape of the wave function and DMC pushes the VMC RMSD towards its ground-state value, the optimal $C_p$ is obtained when DMC and VMC sample the same distribution.

If $C_p$ is too large, the proton wave function will be too localized.
This results in undersampling of the ground-state wave function and is a dangerous scenario.
During the DMC run, the kinetic energy of the protons will likely have mostly small fluctuation in this case.
However, occasional spikes, which are important for an unbiased mean will occur infrequently.
If one misses or discards these spikes, then the results will be biased.
In contrast, undersampling will increase the variance of the wave function without biasing the mean.
The resultant calculation will require more time to reach a certain accuracy target, so a balance needs to be sought.

As shown as the red dashed lines in Fig.~\ref{fig:prot-cp-opt}, we chose isotropic gaussian exponent that are close to optimal but error slightly on the side of undersampling.

\begin{figure}[h]
\centering
\includegraphics[scale=0.6]{h45_xyz-copt}
\caption{Maximum overlap of the proton wave function.}
\label{fig:prot-cp-opt}
\end{figure}


\begin{figure}[h]
\centering
\begin{minipage}{0.49\textwidth}
\centering
\includegraphics[width=\linewidth]{h117_mol-nbjas-rs125}\\
(a) Jastrow pair functions
\end{minipage}
\begin{minipage}{0.49\textwidth}
\centering
\includegraphics[width=\linewidth]{h117_mol-nbbf-rs125}\\
(b) Back flow pair functions
\end{minipage}
\caption{Jastrow and back flow pair functions optimized using dynamic-lattice VMC. The dash-dotted line is the pair function for proton-proton correlation. All other notations are identical to those in Fig.~\ref{fig:hsolid-static-jas-bf}.}
\label{fig:hsolid-dynamic-jas-bf}
\end{figure}

\section{Results}
\label{sec:hsolid-results}
\subsection{Energy vs. Volume}
\begin{figure}[h]
\begin{minipage}{0.48\textwidth}
\includegraphics[width=0.8\columnwidth]{101sd_ev-s3}
%\caption{Energy v.s. volume.\label{fig:si-static-ev}}
\end{minipage}
\begin{minipage}{0.48\textwidth}
\includegraphics[width=0.8\columnwidth]{101se_hp}
%\caption{Enthalpy v.s. pressure.\label{fig:si-static-hp}}
\end{minipage}
\caption{Static-lattice DMC equation-of-state (EOS) relative to Drummond reference $E(\nu) = \frac{2.14020118}{\nu^2} + \frac{0.60521235}{\nu} - 0.6073132$, where $\nu$ is volume per proton in bohr$^3$ and $E(\nu)$ is in Hartree atomic unit. Relative energies are shown in meV per proton (meV/p). Each solid line is obtained using a fitted energy-volume EOS. The EOS is obtained by fitting the finite-size corrected (FSC) total energy as a quadratic function of inverse volume. The markers are finite-size corrected simulation data without performing a fit. \label{fig:static-qmc-vs-drummond}}
\end{figure}

\subsection{Enthalpy vs. Pressure}
In Fig.~\ref{fig:static-enthalpy-vs-pressure}, enthalpies of the candidate structures are plotted relative the my C2/c reference EOS (Yang SJB N72 dskcorr). The EOSs are obtained by fitting the total energy to a quadratic function of inverse volume. The solid lines with symbols are my results. The dot-dashed lines are McMinis' relative enthalpies extracted from Fig. 1 of ref.~\cite{McMinis2015}. The dashed line is McMinis' atomic structure enthalpy shifted by 48 meV/p (1.8 mha/p) to match my energies. The dotted line is Azadi's atomic structure enthalpy.

\begin{figure}[h]
\includegraphics[width=0.8\textwidth]{87b_refit}
\caption{Enthalpy v.s. pressure using Yang SJB N72 dskcorr C2/c as reference.\label{fig:static-enthalpy-vs-pressure}}
\end{figure}
